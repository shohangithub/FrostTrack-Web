<section class="main-content">
  <div class="section-body">
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card mt-2">
          <span class="card-label">Booking Invoices</span>
          <div class="p-10 mt-2">
            <form
              class="product-form"
              [formGroup]="criteriaForm"
              (ngSubmit)="getBookingData()"
            >
              <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <div class="form-group row">
                    <label for="booking" class="col-sm-3 col-form-label"
                      >Find Booking:</label
                    >
                    <div class="col-sm-9">
                      <div class="input-group input-group-select">
                        <ng-select
                          [items]="bookingList"
                          bindLabel="text"
                          bindValue="value"
                          placeholder="Select Booking"
                          formControlName="bookingId"
                          [loading]="isBookingLoading"
                          (change)="getBookingData()"
                        >
                        </ng-select>
                        <div class="input-group-append">
                          <button
                            type="submit"
                            class="btn btn-primary px-2"
                            [disabled]="!criteriaForm.valid"
                          >
                            Show Invoice
                          </button>
                        </div>
                      </div>
                    </div>
                    @if (!criteriaForm.get('bookingId')?.valid &&
                    criteriaForm.get('bookingId')?.touched) {
                    <small class="form-text text-danger text-end">
                      Booking is required
                    </small>
                    }
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card" *ngIf="bookingInvoice">
          <!-- Action Buttons (No Print) -->
          <div class="row no-print mb-3">
            <div class="col-12">
              <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back
                </button>
                <button type="button" class="btn" (click)="downloadPDF()">
                  <i class="fas fa-download me-1"></i>PDF Download
                </button>
                <button
                  type="button"
                  class="btn"
                  [openNewTab]="true"
                  [closeWindow]="false"
                  [previewOnly]="false"
                  [useExistingCss]="true"
                  printTitle="Booking Invoice"
                  printSectionId="print-section-id"
                  ngxPrint
                >
                  <i class="fas fa-print me-1"></i>Print
                </button>
              </div>
            </div>
          </div>

          <div id="print-section-id" class="print-section-container">
            <div class="card invoice-card">
              <div class="card-body p-0">
                <!-- Invoice Print Area -->
                <div
                  #invoiceContent
                  id="invoice-content"
                  class="invoice-container"
                >
                  <!-- Report Header Component -->
                  <app-report-header></app-report-header>

                  <!-- Barcode Section -->
                  <!-- <div class="barcode-section">
                    <svg
                      [id]="'barcode-' + bookingInvoice.bookingNumber"
                      class="barcode"
                    ></svg>
                    <div class="booking-number">
                      {{ bookingInvoice.bookingNumber }}
                    </div>
                  </div> -->

                  <!-- Booking Invoice Title -->
                  <div class="invoice-title-section">
                    <h4 class="text-center">Booking Invoice</h4>
                  </div>

                  <!-- Invoice Details -->
                  <div class="invoice-details">
                    <div class="supplier-details">
                      <p>
                        <strong>Customer Name:</strong>
                        {{ bookingInvoice.customer?.customerName || "N/A" }}
                      </p>
                      <p>
                        <strong>Customer Mobile:</strong>
                        {{ bookingInvoice.customer?.customerMobile || "N/A" }}
                      </p>
                      <p>
                        <strong>Customer Address:</strong>
                        {{ bookingInvoice.customer?.address || "N/A" }}
                      </p>
                    </div>
                    <div class="purchase-details">
                      <p class="mb-1">
                        <strong>Booking Date:</strong>
                        {{
                          bookingInvoice?.bookingDate
                            | date : "dd-MM-yyyy h:mm a"
                        }}
                      </p>
                      <p class="mb-1">
                        <strong>Branch:</strong>
                        {{ bookingInvoice.branch?.name || "N/A" }}
                      </p>
                      <p class="mb-1"><strong>Booked by:</strong> Admin</p>
                      <p class="mb-1"><strong>Saved by:</strong> Admin</p>
                    </div>
                  </div>

                  <!-- Invoice Items Table -->
                  <div class="invoice-items">
                    <table>
                      <thead>
                        <tr>
                          <th class="text-center">Sl.</th>
                          <th class="text-center">Product Name</th>
                          <th class="text-center" style="width: 60px">Unit</th>
                          <th class="text-center" style="width: 80px">
                            Bill Type
                          </th>
                          <th class="text-center" style="width: 60px">
                            Quantity
                          </th>
                          <th class="text-center" style="width: 60px">Rate</th>
                          <th class="text-center" style="width: 80px">
                            Amount
                          </th>
                          <th class="text-center" style="width: 70px">
                            Base Qty
                          </th>
                          <th class="text-center" style="width: 70px">
                            Delivery Qty
                          </th>
                        </tr>
                      </thead>
                      <tbody class="table-body">
                        <tr
                          *ngFor="
                            let item of bookingInvoice?.bookingDetails;
                            let i = index
                          "
                        >
                          <td class="text-center">{{ i + 1 }}</td>
                          <td>
                            <div>
                              <strong>{{
                                item.product?.productName || "N/A"
                              }}</strong>
                            </div>
                            <div class="text-muted small">
                              Code: {{ item.product?.productCode || "N/A" }}
                            </div>
                          </td>
                          <td class="text-center">
                            {{
                              item.bookingUnit?.unitName ||
                                item.bookingUnit?.unitName ||
                                "PCS"
                            }}
                          </td>
                          <td class="text-center">
                            {{ item.billType || "N/A" }}
                          </td>
                          <td class="text-center">
                            {{ item.bookingQuantity | number : "1.2-2" }}
                          </td>
                          <td class="text-center">
                            {{ item.bookingRate | number : "1.2-2" }}
                          </td>
                          <td class="text-end">
                            {{
                              item.bookingQuantity * item.bookingRate
                                | number : "1.2-2"
                            }}
                          </td>
                          <td class="text-center">
                            {{ item.baseQuantity | number : "1.2-2" }}
                          </td>
                          <td class="text-center">0.00</td>
                        </tr>

                        <!-- Total Row -->
                        <tr class="table-light">
                          <td colspan="4" class="text-end">
                            <strong>Total</strong>
                          </td>
                          <td class="text-center">
                            <strong>{{
                              getTotalQuantity() | number : "1.2-2"
                            }}</strong>
                          </td>
                          <td></td>
                          <td class="text-end">
                            <strong>{{
                              getTotalAmount() | number : "1.2-2"
                            }}</strong>
                          </td>
                          <td colspan="2"></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Invoice Summary -->
                  <div class="invoice-summary">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="payment-info">
                          <p><strong>Notes:</strong></p>
                          <p>{{ bookingInvoice.notes || "-" }}</p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="total-summary">
                          <table>
                            <tr>
                              <td><strong>Total Quantity:</strong></td>
                              <td style="text-align: right">
                                {{ getTotalQuantity() | number : "1.2-2" }}
                              </td>
                            </tr>
                            <tr>
                              <td
                                colspan="2"
                                style="
                                  border-bottom: 1px solid rgb(204, 204, 204);
                                "
                              ></td>
                            </tr>
                            <tr>
                              <td><strong>Total Amount:</strong></td>
                              <td style="text-align: right">
                                {{ getTotalAmount() | number : "1.2-2" }}
                              </td>
                            </tr>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Amount in Words -->
                  <div class="amount-words">
                    <p class="mb-2">
                      <strong>In Word:</strong>
                      {{ convertToWords(getTotalAmount()) }}
                    </p>
                  </div>

                  <!-- Report Footer Component -->
                  <app-report-footer></app-report-footer>
                </div>
                <!-- End Invoice Print Area -->
              </div>
            </div>
          </div>

          <!-- Error State -->
          <div class="row" *ngIf="!loadingIndicator && !bookingInvoice">
            <div class="col-12 text-center">
              <div class="alert alert-warning">
                <h5>Booking Not Found</h5>
                <p>The requested booking could not be found.</p>
                <button class="btn btn-primary" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back to Booking List
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
