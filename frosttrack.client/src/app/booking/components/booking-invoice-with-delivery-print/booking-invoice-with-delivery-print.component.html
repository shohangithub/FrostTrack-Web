<section class="main-content">
  <div class="section-body">
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card mt-2">
          <span class="card-label">Booking Invoice with Delivery</span>
          <div class="p-10 mt-2">
            <form
              class="product-form"
              [formGroup]="criteriaForm"
              (ngSubmit)="getBookingData()"
            >
              <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <div class="form-group row">
                    <label for="booking" class="col-sm-3 col-form-label"
                      >Find Booking:</label
                    >
                    <div class="col-sm-9">
                      <div class="input-group input-group-select">
                        <ng-select
                          [items]="bookingList"
                          bindLabel="text"
                          bindValue="value"
                          placeholder="Select Booking"
                          formControlName="bookingId"
                          [loading]="isBookingLoading"
                          (change)="getBookingData()"
                        >
                        </ng-select>
                        <div class="input-group-append">
                          <button
                            type="submit"
                            class="btn btn-primary px-2"
                            [disabled]="!criteriaForm.valid"
                          >
                            Show Invoice
                          </button>
                        </div>
                      </div>
                    </div>
                    @if (!criteriaForm.get('bookingId')?.valid &&
                    criteriaForm.get('bookingId')?.touched) {
                    <small class="form-text text-danger text-end">
                      Booking is required
                    </small>
                    }
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card" *ngIf="bookingInvoice">
          <!-- Action Buttons (No Print) -->
          <div class="row no-print mb-3">
            <div class="col-12">
              <div class="d-flex gap-2 justify-content-end">
                <button
                  type="button"
                  class="btn"
                  [openNewTab]="true"
                  [closeWindow]="true"
                  [previewOnly]="false"
                  [useExistingCss]="true"
                  printTitle="Booking Invoice with Delivery"
                  printSectionId="print-section-id"
                  ngxPrint
                >
                  <i class="fas fa-print me-1"></i>Print
                </button>
              </div>
            </div>
          </div>

          <div id="print-section-id" class="print-section-container">
            <div class="card invoice-card">
              <div class="card-body p-0">
                <!-- Invoice Print Area -->
                <div
                  #invoiceContent
                  id="invoice-content"
                  class="invoice-container"
                >
                  <!-- Report Header Component -->
                  <app-report-invoice-header
                    [Title]="'বুকিং স্লিপ'"
                    [InvoiceNumber]="bookingInvoice.bookingNumber"
                  ></app-report-invoice-header>

                  <!-- Booking Number and Date Section -->
                  <div class="booking-info-box">
                    <table class="info-table">
                      <tr>
                        <td class="info-label">পণ্যের মালিকানার নাম :</td>
                        <td class="info-value">
                          {{ bookingInvoice.customer.customerName }}
                        </td>
                        <td class="info-label">জমাদানের তারিখ :</td>
                        <td class="info-value">
                          {{ bookingInvoice.bookingDate | date : "dd/MM/yyyy" }}
                        </td>
                      </tr>
                      <tr>
                        <td class="info-label">মোবাইল/ফোন</td>
                        <td class="info-value">
                          {{ bookingInvoice.customer.customerMobile }}
                        </td>
                        <td class="info-label">ডেলিভারী নেওয়ার শেষ তারিখ:</td>
                        <td class="info-value">
                          {{ getLastDeliveryDate() | date : "dd/MM/yyyy" }}
                        </td>
                      </tr>
                      <tr>
                        <td class="info-label">প্রতিষ্ঠান/ঠিকানা :</td>
                        <td class="info-value" colspan="3">
                          {{ bookingInvoice.customer.address }}
                        </td>
                      </tr>
                    </table>
                  </div>

                  <!-- সংরক্ষিত পণ্যের বিবরণ (Stored Product Details) -->
                  <div class="section-title">সংরক্ষিত পণ্যের বিবরণ</div>
                  <div class="stored-products-section">
                    <table class="products-table">
                      <thead>
                        <tr>
                          <th>পণ্যের নাম/খাত</th>
                          <th>গ্রহণকৃত একক</th>
                          <th>সংখ্যা</th>
                          <th>পরিমাণ (কেজি)</th>
                          <th>ভাড়ার হার<br />(প্রতি মাস)</th>
                          <th>মোট ভাড়া</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr
                          *ngFor="
                            let item of bookingInvoice.bookingDetails;
                            let i = index
                          "
                        >
                          <td>{{ item.product.productName }}</td>
                          <td class="text-center">
                            {{ item.bookingUnit.unitName }}
                          </td>
                          <td class="text-center">
                            {{ item.bookingQuantity | number : "1.0-0" }}
                          </td>
                          <td class="text-center">
                            {{ item.baseQuantity | number : "1.2-2" }}
                          </td>
                          <td class="text-center">
                            {{ item.bookingRate | number : "1.2-2" }}
                          </td>
                          <td class="text-center">
                            {{
                              item.bookingQuantity * item.bookingRate
                                | number : "1.2-2"
                            }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- ডেলিভারী পণ্যের বিবরণ (Delivery Product Details) -->
                  <div class="section-title">ডেলিভারী পণ্যের বিবরণ</div>
                  <div class="delivery-section">
                    <table class="delivery-table">
                      <thead>
                        <tr>
                          <th>তারিখ</th>
                          <th>পণ্যের নাম</th>
                          <th>সংখ্যা</th>
                          <th>একক</th>
                          <th>পরিমাণ (কেজি)</th>
                          <th>আদায়কৃত ভাড়া</th>
                          <th>অবশিষ্ট পণ্য</th>
                          <th>স্বাক্ষর</th>
                        </tr>
                      </thead>
                      <tbody>
                        <ng-container
                          *ngFor="let delivery of bookingInvoice.deliveries"
                        >
                          <tr
                            *ngFor="
                              let detail of delivery.deliveryDetails;
                              let isFirst = first
                            "
                          >
                            <td
                              *ngIf="isFirst"
                              [attr.rowspan]="delivery.deliveryDetails.length"
                              class="text-center"
                            >
                              {{ delivery.deliveryDate | date : "dd/MM/yyyy" }}
                            </td>
                            <td>{{ detail.productName }}</td>
                            <td class="text-center">
                              {{ detail.deliveryQuantity | number : "1.2-2" }}
                            </td>
                            <td>{{ detail.deliveryUnitName }}</td>
                            <td class="text-center">
                              {{ detail.baseQuantity | number : "1.2-2" }}
                            </td>
                            <td
                              *ngIf="isFirst"
                              [attr.rowspan]="delivery.deliveryDetails.length"
                              class="text-center"
                            >
                              {{
                                delivery.chargeAmount + delivery.adjustmentValue
                                  | number : "1.2-2"
                              }}
                            </td>
                            <td class="text-center">
                              {{
                                getRemainingQuantity(detail.productId)
                                  | number : "1.2-2"
                              }}
                            </td>
                            <td
                              *ngIf="isFirst"
                              [attr.rowspan]="delivery.deliveryDetails.length"
                            ></td>
                          </tr>
                        </ng-container>
                        <!-- Empty rows if no deliveries -->
                        <ng-container
                          *ngIf="
                            !bookingInvoice.deliveries ||
                            bookingInvoice.deliveries.length === 0
                          "
                        >
                          <tr
                            *ngFor="let row of [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]"
                          >
                            <td style="height: 40px"></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                          </tr>
                        </ng-container>
                      </tbody>
                    </table>
                  </div>

                  <!-- Footer Note -->
                  <div class="footer-note">
                    (বিশেষ দ্রষ্টব্য: অপর পৃষ্ঠায় দস্তখত করিয়া রশিদটি বুঝিয়া
                    নিবেন।)
                  </div>

                  <!-- Report Footer Component -->
                  <app-report-footer></app-report-footer>
                </div>
                <!-- End Invoice Print Area -->
              </div>
            </div>
          </div>

          <!-- Error State -->
          <div class="row" *ngIf="!loadingIndicator && !bookingInvoice">
            <div class="col-12 text-center">
              <div class="alert alert-warning">
                <h5>Booking Not Found</h5>
                <p>The requested booking could not be found.</p>
                <button class="btn btn-primary" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back to Booking List
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
