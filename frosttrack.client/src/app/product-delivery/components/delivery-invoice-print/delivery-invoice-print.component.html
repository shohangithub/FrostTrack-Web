<section class="main-content">
  <div class="section-body">
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card mt-2">
          <span class="card-label">Delivery Invoices</span>
          <div class="p-10 mt-2">
            <form
              class="product-form"
              [formGroup]="criteriaForm"
              (ngSubmit)="getDeliveryData()"
            >
              <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <div class="form-group row">
                    <label for="delivery" class="col-sm-3 col-form-label"
                      >Find Delivery:</label
                    >
                    <div class="col-sm-9">
                      <div class="input-group input-group-select">
                        <ng-select
                          [items]="deliveryList"
                          bindLabel="text"
                          bindValue="value"
                          placeholder="Select Delivery"
                          formControlName="deliveryId"
                          [loading]="isDeliveryLoading"
                          (change)="getDeliveryData()"
                        >
                        </ng-select>
                        <div class="input-group-append">
                          <button
                            type="submit"
                            class="btn btn-primary px-2"
                            [disabled]="!criteriaForm.valid"
                          >
                            Show Invoice
                          </button>
                        </div>
                      </div>
                    </div>
                    @if (!criteriaForm.get('deliveryId')?.valid &&
                    criteriaForm.get('deliveryId')?.touched) {
                    <small class="form-text text-danger text-end">
                      Delivery is required
                    </small>
                    }
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card" *ngIf="deliveryInvoice">
          <!-- Action Buttons (No Print) -->
          <div class="row no-print mb-3">
            <div class="col-12">
              <div class="d-flex gap-2 justify-content-end">
                <!-- <button type="button" class="btn" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back
                </button> -->
                <!-- <button type="button" class="btn" (click)="downloadPDF()">
                  <i class="fas fa-download me-1"></i>PDF Download
                </button> -->
                <button
                  type="button"
                  class="btn"
                  [openNewTab]="true"
                  [closeWindow]="true"
                  [previewOnly]="false"
                  [useExistingCss]="true"
                  printTitle="Delivery Invoice"
                  printSectionId="print-section-id"
                  ngxPrint
                >
                  <i class="fas fa-print me-1"></i>Print
                </button>
              </div>
            </div>
          </div>

          <div id="print-section-id" class="print-section-container">
            <div class="card invoice-card">
              <div class="card-body p-0">
                <!-- Invoice Print Area -->
                <div
                  #invoiceContent
                  id="invoice-content"
                  class="invoice-container"
                >
                  <!-- Report Header Component -->
                  <app-report-invoice-header
                    [Title]="'ডেলিভারি স্লিপ'"
                    [InvoiceNumber]="deliveryInvoice.deliveryNumber"
                  ></app-report-invoice-header>

                  <!-- Delivery Information Section -->
                  <div class="booking-info-box">
                    <table class="info-table">
                      <tr>
                        <td class="info-label">পণ্যের মালিকানার নাম :</td>
                        <td class="info-value">
                          {{ deliveryInvoice.customer?.customerName || "" }}
                        </td>
                        <td class="info-label">বুকিং নম্বর :</td>
                        <td class="info-value">
                          {{ deliveryInvoice.bookingNumber || "" }}
                        </td>
                      </tr>
                      <tr>
                        <td class="info-label">মোবাইল/ফোন:</td>
                        <td class="info-value">
                          {{ deliveryInvoice.customer?.customerMobile || "" }}
                        </td>
                        <td class="info-label">ডেলিভারীর তারিখ :</td>
                        <td class="info-value">
                          {{
                            deliveryInvoice.deliveryDate | date : "dd/MM/yyyy"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <td class="info-label">বুকিং তারিখ :</td>
                        <td class="info-value">
                          {{
                            deliveryInvoice.booking?.bookingDate
                              | date : "dd/MM/yyyy"
                          }}
                        </td>
                        <td class="info-label">ডেলিভারী নেওয়ার শেষ তারিখ:</td>
                        <td class="info-value">
                          {{
                            deliveryInvoice.booking?.lastDeliveryDate
                              | date : "dd/MM/yyyy"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <td class="info-label">প্রতিষ্ঠান/ঠিকানা :</td>
                        <td class="info-value" colspan="3">
                          {{ deliveryInvoice.customer?.address || "" }}
                        </td>
                      </tr>
                    </table>
                  </div>

                  <!-- ডেলিভারী পণ্যের বিবরণ (Delivery Product Details) -->
                  <div class="section-title">ডেলিভারী পণ্যের বিবরণ</div>
                  <div class="stored-products-section">
                    <table class="products-table">
                      <thead>
                        <tr>
                          <th>ক্রমিক</th>
                          <th>পণ্যের নাম</th>
                          <th>একক</th>
                          <th>সংখ্যা</th>
                          <th>পরিমাণ (কেজি)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr
                          *ngFor="
                            let item of deliveryInvoice.deliveryDetails;
                            let i = index
                          "
                        >
                          <td class="text-center">{{ i + 1 }}</td>
                          <td>{{ item.productName }}</td>
                          <td class="text-center">
                            {{ item.deliveryUnitName }}
                          </td>
                          <td class="text-center">
                            {{ item.deliveryQuantity | number : "1.2-2" }}
                          </td>
                          <td class="text-center">
                            {{ item.baseQuantity | number : "1.2-2" }}
                          </td>
                        </tr>
                      </tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td colspan="3" class="text-end fw-bold">
                            সর্বমোট :
                          </td>
                          <td class="text-center fw-bold">
                            {{ getTotalQuantity() | number : "1.2-2" }}
                          </td>
                          <td class="text-center fw-bold">
                            {{ getTotalBaseQuantity() | number : "1.2-2" }}
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>

                  <!-- Amount in Words -->
                  <!-- <div class="amount-words">
                    <strong>Amount in Words:</strong>
                    <span class="ms-2">{{
                      convertToWords(deliveryInvoice.chargeAmount)
                    }}</span>
                  </div> -->

                  <!-- Summary Section -->
                  <div class="summary-section">
                    <table class="summary-table">
                      <tr>
                        <td class="summary-label">মোট বুকিং চার্জ:</td>
                        <td class="summary-value text-end">
                          {{
                            deliveryInvoice.totalBookingAmount
                              | number : "1.2-2"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <td class="summary-label">মোট পরিশোধিত চার্জ:</td>
                        <td class="summary-value text-end">
                          {{
                            deliveryInvoice.totalPaidAmount | number : "1.2-2"
                          }}
                        </td>
                      </tr>
                      <tr>
                        <td class="summary-label">অতিরিক্ত চার্জ:</td>
                        <td class="summary-value text-end">
                          {{ deliveryInvoice.extraCharge | number : "1.2-2" }}
                        </td>
                      </tr>
                      <!-- <tr>
                        <td class="summary-label">ডেলিভারী চার্জ:</td>
                        <td class="summary-value text-end">
                          {{ deliveryInvoice.chargeAmount | number : "1.2-2" }}
                        </td>
                      </tr> -->
                      @if(deliveryInvoice.adjustmentValue !== 0) {
                      <tr>
                        <td class="summary-label">সমন্বয় (Adjustment):</td>
                        <td class="summary-value text-end">
                          {{
                            deliveryInvoice.adjustmentValue | number : "1.2-2"
                          }}
                        </td>
                      </tr>
                      }
                      <tr class="summary-total">
                        <td class="summary-label">
                          <strong>বকেয়া পরিমাণ:</strong>
                        </td>
                        <td class="summary-value text-end">
                          <strong>{{
                            deliveryInvoice.dueAmount | number : "1.2-2"
                          }}</strong>
                        </td>
                      </tr>
                    </table>
                  </div>

                  <!-- Notes Section -->
                  @if(deliveryInvoice.notes) {
                  <div class="notes-section">
                    <strong>Notes:</strong>
                    <p>{{ deliveryInvoice.notes }}</p>
                  </div>
                  }

                  <!-- Signature Section -->
                  <div class="signature-section">
                    <div class="signature-box">
                      <div class="signature-line"></div>
                      <div class="signature-label">গ্রাহকের স্বাক্ষর</div>
                      <div class="signature-sublabel">(Customer Signature)</div>
                    </div>
                    <div class="signature-box">
                      <div class="signature-line"></div>
                      <div class="signature-label">কর্তৃপক্ষের স্বাক্ষর</div>
                      <div class="signature-sublabel">
                        (Authorized Signature)
                      </div>
                    </div>
                  </div>

                  <!-- Report Footer Component -->
                  <app-report-footer></app-report-footer>
                </div>
                <!-- End Invoice Print Area -->
              </div>
            </div>
          </div>

          <!-- Error State -->
          <div class="row" *ngIf="!loadingIndicator && !deliveryInvoice">
            <div class="col-12 text-center">
              <div class="alert alert-warning">
                <h5>Delivery Not Found</h5>
                <p>The requested delivery could not be found.</p>
                <button class="btn btn-primary" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back to Delivery List
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
