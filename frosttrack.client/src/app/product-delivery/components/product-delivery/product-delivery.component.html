<section class="main-content">
  <div class="section-body">
    <div class="row">
      <form
        class="register-form"
        [formGroup]="deliveryForm"
        (ngSubmit)="onSubmit()"
      >
        <div class="container mt-2">
          <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
              <div class="card mb-3">
                <span class="card-label">Delivery Information</span>
                <div class="card-body-narrow">
                  <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                      <div class="form-group row">
                        <label
                          for="deliveryNumber"
                          class="col-sm-4 col-form-label"
                          >Delivery Number:</label
                        >
                        <div class="col-sm-8">
                          <input
                            type="text"
                            class="form-control form-control-sm"
                            id="deliveryNumber"
                            formControlName="deliveryNumber"
                            readonly
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                      <div class="form-group row">
                        <label
                          for="deliveryDate"
                          class="col-sm-4 col-form-label"
                          >Date:</label
                        >
                        <div class="col-sm-8">
                          <input
                            type="date"
                            class="form-control form-control-sm"
                            id="deliveryDate"
                            formControlName="deliveryDate"
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                      <div class="form-group row">
                        <label for="bookingId" class="col-sm-4 col-form-label"
                          >Booking:</label
                        >
                        <div class="col-sm-8">
                          <ng-select
                            id="bookingId"
                            formControlName="bookingId"
                            [items]="bookings"
                            bindLabel="text"
                            bindValue="value"
                            [loading]="bookingLoading"
                            [clearable]="false"
                            placeholder="Select booking"
                            class="ng-select-sm"
                          >
                          </ng-select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                      <div class="form-group row">
                        <label class="col-sm-4 col-form-label">Customer:</label>
                        <div class="col-sm-8">
                          <input
                            type="text"
                            class="form-control form-control-sm"
                            [value]="bookingData?.customerName || ''"
                            readonly
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                      <div class="form-group row">
                        <label class="col-sm-4 col-form-label"
                          >Booking Date:</label
                        >
                        <div class="col-sm-8">
                          <input
                            type="text"
                            class="form-control form-control-sm"
                            [value]="
                              (bookingData?.bookingDate
                                | date : 'dd/MM/yyyy') || ''
                            "
                            readonly
                          />
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                      <div class="form-group row">
                        <label class="col-sm-4 col-form-label"
                          >D. Last Date:</label
                        >
                        <div class="col-sm-8">
                          <input
                            type="text"
                            class="form-control form-control-sm"
                            [value]="
                              (bookingData?.lastDeliveryDate
                                | date : 'dd/MM/yyyy') || ''
                            "
                            readonly
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8col-xs-12">
              <!-- Delivery Items Section -->
              <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card mb-3">
                  <span class="card-label">Delivery Items</span>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="table-responsive">
                          <table class="table table-sm">
                            <thead>
                              <tr>
                                <th scope="col" class="text-center">#</th>
                                <th scope="col" class="text-center">Product</th>
                                <th scope="col" class="text-center">Booked</th>
                                <th scope="col" class="text-center">
                                  Delivered
                                </th>
                                <th scope="col" class="text-center">
                                  Remaining
                                </th>
                                <th scope="col" class="text-center">Unit</th>
                                <th
                                  scope="col"
                                  style="width: 15%"
                                  class="text-center"
                                >
                                  Qty
                                </th>
                                <th
                                  scope="col"
                                  style="width: 15%"
                                  class="text-center"
                                >
                                  Bill
                                </th>
                              </tr>
                            </thead>
                            <tbody formArrayName="deliveryDetails">
                              @for (detail of deliveryDetails.controls; let i =
                              $index; track i) {
                              <tr [formGroupName]="i">
                                <td class="text-center">{{ i + 1 }}</td>
                                <td>
                                  <small>{{
                                    detail.get("productName")?.value
                                  }}</small>
                                </td>
                                <td class="text-center">
                                  {{
                                    detail.get("bookingQuantity")?.value
                                      | number : "1.2-2"
                                  }}
                                </td>
                                <td class="text-center">
                                  {{
                                    detail.get("totalDeliveredQuantity")?.value
                                      | number : "1.2-2"
                                  }}
                                </td>
                                <td class="text-center">
                                  <span class="badge bg-warning text-dark">
                                    {{
                                      detail.get("remainingQuantity")?.value
                                        | number : "1.2-2"
                                    }}
                                  </span>
                                </td>
                                <td>
                                  <ng-select
                                    formControlName="deliveryUnitId"
                                    [items]="
                                      detail.get('availableUnits')?.value
                                    "
                                    bindLabel="unitName"
                                    bindValue="id"
                                    [clearable]="false"
                                    class="ng-select-sm"
                                  >
                                  </ng-select>
                                </td>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-sm text-end"
                                    formControlName="deliveryQuantity"
                                    (blur)="validateQuantity(i)"
                                  />
                                </td>
                                <td>
                                  <input
                                    type="number"
                                    class="form-control form-control-sm text-end"
                                    formControlName="totalCharge"
                                    readonly
                                  />
                                </td>
                              </tr>
                              } @empty {
                              <tr>
                                <td colspan="8" class="text-center text-muted">
                                  No items available for delivery
                                </td>
                              </tr>
                              }
                            </tbody>
                            <tfoot *ngIf="deliveryDetails.length > 0">
                              <tr>
                                <td colspan="7" class="text-end fw-bold">
                                  Subtotal:
                                </td>
                                <td class="text-end fw-bold">
                                  {{
                                    deliveryForm.get("chargeAmount")?.value
                                      | number : "1.2-2"
                                  }}
                                </td>
                              </tr>
                            </tfoot>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
              <!-- Billing, Payment and Actions Row -->
              <div class="row">
                <!-- Transaction Section (Always visible, disabled when unchecked) -->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <div class="card mb-3">
                    <span class="card-label">
                      <input
                        type="checkbox"
                        class="form-check-input me-2"
                        id="createTransaction"
                        formControlName="createTransaction"
                      />

                      <label class="form-check-label" for="createTransaction">
                        Collect Payment
                      </label>
                    </span>
                    <div class="card-body">
                      <div class="form-group row mb-2">
                        <label class="col-sm-5 col-form-label"
                          >Total Charges:</label
                        >
                        <div class="col-sm-7">
                          <input
                            type="text"
                            class="form-control form-control-sm text-end"
                            [value]="
                              deliveryForm.get('chargeAmount')?.value
                                | number : '1.2-2'
                            "
                            readonly
                          />
                        </div>
                      </div>
                      <div class="form-group row mb-2">
                        <label class="col-sm-5 col-form-label"
                          >Previous Payments:</label
                        >
                        <div class="col-sm-7">
                          <input
                            type="text"
                            class="form-control form-control-sm text-end"
                            [value]="
                              deliveryForm.get('totalPreviousPayments')?.value
                                | number : '1.2-2'
                            "
                            readonly
                          />
                        </div>
                      </div>
                      <div class="form-group row mb-0">
                        <label class="col-sm-5 col-form-label"
                          ><strong>Remaining Balance:</strong></label
                        >
                        <div class="col-sm-7">
                          <input
                            type="text"
                            class="form-control form-control-sm text-end fw-bold"
                            [value]="
                              deliveryForm.get('remainingBalance')?.value
                                | number : '1.2-2'
                            "
                            readonly
                          />
                        </div>
                      </div>
                      <div class="form-group row mb-2">
                        <label class="col-sm-5 col-form-label">Amount:</label>
                        <div class="col-sm-7">
                          <input
                            type="text"
                            class="form-control form-control-sm text-end"
                            formControlName="transactionAmount"
                            [disabled]="
                              deliveryForm.get('createTransaction')?.value
                                ? false
                                : true
                            "
                          />
                        </div>
                      </div>
                      <!-- <div class="form-group row mb-2">
                        <label class="col-sm-5 col-form-label"
                          >Payment Method:</label
                        >
                        <div class="col-sm-7">
                          <ng-select
                            formControlName="paymentMethod"
                            [items]="paymentMethods"
                            bindLabel="label"
                            bindValue="value"
                            [clearable]="false"
                            class="ng-select-sm"
                            [disabled]="
                              !deliveryForm.get('createTransaction')?.value
                            "
                          >
                          </ng-select>
                        </div>
                      </div> -->
                      <div class="form-group row mb-0">
                        <label class="col-sm-5 col-form-label">Notes:</label>
                        <div class="col-sm-7">
                          <textarea
                            class="form-control form-control-sm"
                            formControlName="transactionNotes"
                            rows="2"
                            [disabled]="
                              !deliveryForm.get('createTransaction')?.value
                            "
                          ></textarea>
                        </div>
                      </div>
                      <div class="row">
                        <div
                          class="col-lg-12 col-md-12 col-sm-12 col-xs-12 text-end mt-2"
                        >
                          <button
                            type="submit"
                            class="btn btn-primary btn-block btn-sm mb-2"
                            [disabled]="isSubmitting || !bookingData"
                          >
                            <i class="fas fa-save"></i>
                            {{
                              isSubmitting
                                ? "Processing..."
                                : "Complete Delivery"
                            }}
                          </button>
                          <!-- <a
                            routerLink="/product-delivery/list"
                            class="btn btn-danger btn-block btn-sm"
                          >
                            <i class="fas fa-times"></i> Cancel
                          </a> -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Notes and Action Buttons -->
                <!-- <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="card mb-3">
                    <span class="card-label">Notes & Actions</span>
                    <div class="card-body">
                      <div class="form-group mb-2">
                        <textarea
                          class="form-control form-control-sm"
                          formControlName="notes"
                          rows="3"
                          placeholder="Add delivery notes..."
                        ></textarea>
                      </div>
                    </div>
                  </div>
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
