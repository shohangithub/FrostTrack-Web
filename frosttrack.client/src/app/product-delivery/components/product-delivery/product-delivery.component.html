<section class="main-content">
  <div class="section-body">
    <div class="row">
      <form
        class="register-form"
        [formGroup]="register"
        (ngSubmit)="delivery(register)"
      >
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <div class="card mb-3">
            <div class="card-body-narrow">
              <div class="row">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="deliveryNumber" class="col-sm-4 col-form-label"
                      >Delivery Number:</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="deliveryNumber"
                        formControlName="deliveryNumber"
                        readonly
                      />
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="branch" class="col-sm-4 col-form-label"
                      >Delivery for:</label
                    >
                    <div class="col-sm-8">
                      <select
                        class="form-select form-control-sm"
                        formControlName="branchId"
                        required
                        [disabled]="true"
                      >
                        <option value="" selected disabled>
                          Please select
                        </option>
                        @for (option of branchs; track option) {
                        <option [value]="option.value">
                          {{ option.text }}
                        </option>
                        }
                      </select>
                      @if (!register.get('branchId')?.valid &&
                      register.get('branchId')?.touched) {
                      <small class="form-text text-danger">
                        Branch is required
                      </small>
                      }
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="deliveryDate" class="col-sm-4 col-form-label"
                      >Date:</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="deliveryDate"
                        formControlName="deliveryDate"
                        readonly
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
            <div class="row">
              <div class="col-lg-5 col-md-5 col-sm-5 col-xs-12">
                <div class="card mb-2">
                  <span class="card-label">Customer Information</span>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="form-group row">
                          <label for="booking" class="col-sm-4 col-form-label"
                            >Booking:</label
                          >
                          <div class="col-sm-8">
                            <ng-select
                              [items]="bookings"
                              bindLabel="text"
                              bindValue="value"
                              formControlName="booking"
                              [loading]="bookingLoading"
                              (ngModelChange)="onBookingChange()"
                            >
                            </ng-select>
                          </div>
                          @if (!register.get('booking')?.valid &&
                          register.get('booking')?.touched) {
                          <small class="form-text text-danger">
                            Booking is required
                          </small>
                          }
                        </div>
                      </div>
                      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pb-3">
                        <div class="form-group row">
                          <label
                            for="bookingNumber"
                            class="col-sm-4 col-form-label"
                            >Booking Number:</label
                          >
                          <div class="col-sm-8">
                            <input
                              type="text"
                              class="form-control form-control-sm"
                              id="bookingNumber"
                              [value]="register.get('booking')?.value?.['text']??''"
                              readonly
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-7 col-md-7 col-sm-7 col-xs-12">
                <div class="card mb-2">
                  <span class="card-label">Product Details</span>
                  <div class="card-body">
                    <form
                      class="register-form"
                      [formGroup]="productForm"
                      (ngSubmit)="addToCart()"
                    >
                      <div class="row">
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                          <div class="form-group row">
                            <label for="product" class="col-sm-4 col-form-label"
                              >Product:</label
                            >
                            <div class="col-sm-8">
                              <ng-select
                                [items]="customerStockProducts"
                                bindLabel="productName"
                                formControlName="product"
                                [loading]="productLoading"
                                (ngModelChange)="setProductDetails()"
                                [disabled]="!register.get('customer')?.value"
                              >
                                <ng-template ng-option-tmp let-item="item">
                                  <div>{{ item.productName }}</div>
                                  <small class="text-muted"
                                    >Stock: {{ item.availableStock }}</small
                                  >
                                </ng-template>
                              </ng-select>
                            </div>
                            @if (!productForm.get('product')?.valid &&
                            productForm.get('product')?.touched) {
                            <small class="form-text text-danger">
                              Product is required
                            </small>
                            }
                          </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                          <div class="form-group row">
                            <label
                              for="deliveryUnit"
                              class="col-sm-4 col-form-label"
                              >Unit:</label
                            >
                            <div class="col-sm-8">
                              <ng-select
                                [items]="productUnits"
                                bindLabel="label"
                                formControlName="deliveryUnit"
                                [loading]="productUnitLoading"
                              >
                              </ng-select>
                            </div>
                            @if (!productForm.get('deliveryUnit')?.valid &&
                            productForm.get('deliveryUnit')?.touched) {
                            <small class="form-text text-danger">
                              Unit is required
                            </small>
                            }
                          </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                          <div class="form-group row">
                            <label
                              for="availableStock"
                              class="col-sm-4 col-form-label"
                              >Available Stock:</label
                            >
                            <div class="col-sm-8">
                              <input
                                type="number"
                                class="form-control form-control-sm"
                                id="availableStock"
                                formControlName="availableStock"
                                readonly
                              />
                            </div>
                          </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                          <div class="form-group row">
                            <label
                              for="chargeAmount"
                              class="col-sm-4 col-form-label"
                              >Charge Amount:</label
                            >
                            <div class="col-sm-8">
                              <input
                                type="number"
                                class="form-control form-control-sm"
                                id="chargeAmount"
                                formControlName="chargeAmount"
                              />
                            </div>
                            @if (!productForm.get('chargeAmount')?.valid &&
                            productForm.get('chargeAmount')?.touched) {
                            <small class="form-text text-danger">
                              Charge Amount is required
                            </small>
                            }
                          </div>
                        </div>
                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                          <div class="form-group row">
                            <label
                              for="deliveryQuantity"
                              class="col-sm-4 col-form-label"
                              >Quantity:</label
                            >
                            <div class="col-sm-8">
                              <input
                                type="number"
                                class="form-control form-control-sm"
                                id="deliveryQuantity"
                                formControlName="deliveryQuantity"
                                (blur)="validateDeliveryQuantity()"
                              />
                            </div>
                            @if (!productForm.get('deliveryQuantity')?.valid &&
                            productForm.get('deliveryQuantity')?.touched) {
                            <small class="form-text text-danger">
                              Quantity is required
                            </small>
                            }
                          </div>
                        </div>
                        <div
                          class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pb-3"
                        >
                          <div class="form-group row">
                            <div class="col-sm-12">
                              <button
                                class="btn btn-primary btn-sm w-100"
                                type="submit"
                              >
                                Add to Cart
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                  <span class="card-label">Product List</span>
                  <div class="card-body p-0">
                    <div class="table-responsive">
                      <table class="table table-striped table-sm">
                        <thead>
                          <tr>
                            <th>Product Name</th>
                            <th>Unit</th>
                            <th>Charge Amount</th>
                            <th>Quantity</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody formArrayName="deliveryDetails">
                          @for (item of deliveryDetails.controls; track $index)
                          {
                          <tr [formGroupName]="$index">
                            <td>{{ item.get("productName")?.value }}</td>
                            <td>{{ item.get("deliveryUnitName")?.value }}</td>
                            <td>{{ item.get("chargeAmount")?.value }}</td>
                            <td>{{ item.get("deliveryQuantity")?.value }}</td>
                            <td>
                              <button
                                class="btn btn-danger btn-sm"
                                type="button"
                                (click)="removeFromCart($index)"
                              >
                                Remove
                              </button>
                            </td>
                          </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
            <div class="card">
              <span class="card-label">Additional Information</span>
              <div class="card-body">
                <div class="row">
                  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="form-group">
                      <label for="notes" class="col-form-label">Notes:</label>
                      <textarea
                        class="form-control form-control-sm"
                        id="notes"
                        formControlName="notes"
                        rows="4"
                      ></textarea>
                    </div>
                  </div>
                  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 pb-3">
                    <div class="form-group">
                      <button
                        class="btn btn-success btn-sm w-100"
                        type="submit"
                        [disabled]="isSubmitted"
                      >
                        {{
                          isSubmitted ? "Processing..." : "Complete Delivery"
                        }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
