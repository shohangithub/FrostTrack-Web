<section class="main-content">
  <div class="section-body">
    <!-- Filter Section -->
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card mt-2">
          <span class="card-label">Transaction Report</span>
          <div class="p-10 mt-2">
            <form
              class="product-form"
              [formGroup]="reportForm"
              (ngSubmit)="onSubmit()"
            >
              <div class="row">
                <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                  <div class="form-group row">
                    <label for="startDate" class="col-sm-12 col-form-label"
                      >Start Date <span class="text-danger">*</span></label
                    >
                    <div class="col-sm-12">
                      <input
                        type="date"
                        id="startDate"
                        class="form-control"
                        formControlName="startDate"
                        [class.is-invalid]="
                          reportForm.get('startDate')?.invalid &&
                          reportForm.get('startDate')?.touched
                        "
                      />
                      @if(reportForm.get('startDate')?.invalid &&
                      reportForm.get('startDate')?.touched) {
                      <small class="form-text text-danger"
                        >Start date is required</small
                      >
                      }
                    </div>
                  </div>
                </div>

                <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                  <div class="form-group row">
                    <label for="endDate" class="col-sm-12 col-form-label"
                      >End Date <span class="text-danger">*</span></label
                    >
                    <div class="col-sm-12">
                      <input
                        type="date"
                        id="endDate"
                        class="form-control"
                        formControlName="endDate"
                        [class.is-invalid]="
                          reportForm.get('endDate')?.invalid &&
                          reportForm.get('endDate')?.touched
                        "
                      />
                      @if(reportForm.get('endDate')?.invalid &&
                      reportForm.get('endDate')?.touched) {
                      <small class="form-text text-danger"
                        >End date is required</small
                      >
                      }
                    </div>
                  </div>
                </div>

                <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                  <div class="form-group row">
                    <label
                      for="transactionType"
                      class="col-sm-12 col-form-label"
                      >Transaction Type</label
                    >
                    <div class="col-sm-12">
                      <ng-select
                        id="transactionType"
                        [items]="transactionTypeOptions"
                        bindLabel="text"
                        bindValue="value"
                        placeholder="Select Type"
                        formControlName="transactionType"
                      ></ng-select>
                    </div>
                  </div>
                </div>

                <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
                  <div class="form-group row">
                    <label
                      for="transactionFlow"
                      class="col-sm-12 col-form-label"
                      >Transaction Flow</label
                    >
                    <div class="col-sm-12">
                      <ng-select
                        id="transactionFlow"
                        [items]="transactionFlowOptions"
                        bindLabel="text"
                        bindValue="value"
                        placeholder="Select Flow"
                        formControlName="transactionFlow"
                      ></ng-select>
                    </div>
                  </div>
                </div>

                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <div class="form-group row">
                    <div class="col-sm-12 text-end">
                      <button
                        type="submit"
                        class="btn btn-primary px-2"
                        [disabled]="isLoading || reportForm.invalid"
                      >
                        @if(isLoading) {
                        <span
                          class="spinner-border spinner-border-sm me-2"
                          role="status"
                        ></span>
                        } Show Report
                      </button>
                      @if(showReport) {
                      <button
                        type="button"
                        class="btn btn-secondary ms-2 px-2"
                        (click)="resetReport()"
                      >
                        Clear
                      </button>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Display Section -->
    @if(showReport && !isLoading) {
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card">
          <!-- Action Buttons (No Print) -->
          <div class="row no-print mb-3">
            <div class="col-12">
              <div class="d-flex gap-2 justify-content-end">
                <button
                  type="button"
                  class="btn"
                  [openNewTab]="true"
                  [closeWindow]="true"
                  [previewOnly]="false"
                  [useExistingCss]="true"
                  printTitle="Transaction Report"
                  printSectionId="print-section-id"
                  ngxPrint
                >
                  <i class="fas fa-print me-1"></i>Print
                </button>
              </div>
            </div>
          </div>

          <div id="print-section-id" class="print-section-container">
            <div class="card invoice-card">
              <div class="card-body p-0">
                <!-- Report Print Area -->
                <div class="invoice-container">
                  <!-- Report Header Component -->
                  <app-report-invoice-header
                    [Title]="'Transaction Report'"
                    [InvoiceNumber]="''"
                  ></app-report-invoice-header>

                  <!-- Report Information Section -->
                  <div class="booking-info-box">
                    <table class="info-table">
                      <tr>
                        <td class="info-label">Report Period:</td>
                        <td class="info-value">
                          {{
                            reportForm.get("startDate")?.value
                              | date : "dd/MM/yyyy"
                          }}
                          -
                          {{
                            reportForm.get("endDate")?.value
                              | date : "dd/MM/yyyy"
                          }}
                        </td>
                        <td class="info-label">Generated On:</td>
                        <td class="info-value">
                          {{ today | date : "dd/MM/yyyy HH:mm" }}
                        </td>
                      </tr>
                      @if(reportForm.get('transactionType')?.value ||
                      reportForm.get('transactionFlow')?.value) {
                      <tr>
                        @if(reportForm.get('transactionType')?.value) {
                        <td class="info-label">Transaction Type:</td>
                        <td class="info-value">
                          {{
                            getTransactionTypeLabel(
                              reportForm.get("transactionType")?.value
                            )
                          }}
                        </td>
                        } @else {
                        <td class="info-label">Transaction Type:</td>
                        <td class="info-value">All Types</td>
                        } @if(reportForm.get('transactionFlow')?.value) {
                        <td class="info-label">Transaction Flow:</td>
                        <td class="info-value">
                          {{
                            reportForm.get("transactionFlow")?.value === "IN"
                              ? "Inflow (Money In)"
                              : "Outflow (Money Out)"
                          }}
                        </td>
                        } @else {
                        <td class="info-label">Transaction Flow:</td>
                        <td class="info-value">All Flows</td>
                        }
                      </tr>
                      }
                      <tr>
                        <td class="info-label">Total Transactions:</td>
                        <td class="info-value">{{ transactions.length }}</td>
                        <td class="info-label">Net Amount:</td>
                        <td class="info-value">
                          {{ netAmount | number : "1.2-2" }}
                        </td>
                      </tr>
                    </table>
                  </div>

                  <!-- Transaction Details Section -->
                  <div class="section-title">Transaction Details</div>
                  @if(transactions.length > 0) {
                  <div class="stored-products-section">
                    <table class="products-table">
                      <thead>
                        <tr>
                          <th>ক্রমিক</th>
                          <th>Date</th>
                          <th>Code</th>
                          <th>Type</th>
                          <th>Description</th>
                          <th>Payment</th>
                          <th>Flow</th>
                          <th>Amount</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr
                          *ngFor="
                            let transaction of transactions;
                            let i = index
                          "
                        >
                          <td class="text-center">{{ i + 1 }}</td>
                          <td class="text-center">
                            {{
                              transaction.transactionDate | date : "dd/MM/yyyy"
                            }}
                          </td>
                          <td>{{ transaction.transactionCode }}</td>
                          <td>
                            {{
                              getTransactionTypeLabel(
                                transaction.transactionType
                              )
                            }}
                          </td>
                          <td>{{ transaction.description }}</td>
                          <td class="text-center">
                            {{
                              getPaymentMethodLabel(transaction.paymentMethod)
                            }}
                          </td>
                          <td class="text-center">
                            <span
                              [class]="
                                'flow-badge ' +
                                (transaction.transactionFlow === 'IN'
                                  ? 'flow-in'
                                  : 'flow-out')
                              "
                            >
                              {{ transaction.transactionFlow }}
                            </span>
                          </td>
                          <td class="text-end">
                            {{ transaction.netAmount | number : "1.2-2" }}
                          </td>
                        </tr>
                      </tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td colspan="7" class="text-end fw-bold">
                            Total Inflow:
                          </td>
                          <td class="text-end fw-bold">
                            {{ totalInflow | number : "1.2-2" }}
                          </td>
                        </tr>
                        <tr class="total-row">
                          <td colspan="7" class="text-end fw-bold">
                            Total Outflow:
                          </td>
                          <td class="text-end fw-bold">
                            {{ totalOutflow | number : "1.2-2" }}
                          </td>
                        </tr>
                        <tr class="total-row">
                          <td colspan="7" class="text-end fw-bold">
                            Net Amount:
                          </td>
                          <td class="text-end fw-bold">
                            {{ netAmount | number : "1.2-2" }}
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                  } @else {
                  <div class="notes-section">
                    <p class="text-center mb-0">
                      No transactions found for the selected criteria.
                    </p>
                  </div>
                  }

                  <!-- Signature Section -->
                  <div class="signature-section">
                    <div class="signature-box">
                      <div class="signature-line"></div>
                      <div class="signature-label">Prepared By</div>
                      <div class="signature-sublabel">(System Admin)</div>
                    </div>
                    <div class="signature-box">
                      <div class="signature-line"></div>
                      <div class="signature-label">Authorized By</div>
                      <div class="signature-sublabel">(Management)</div>
                    </div>
                  </div>

                  <!-- Report Footer Component -->
                  <app-report-footer></app-report-footer>
                </div>
                <!-- End Report Print Area -->
              </div>
            </div>
          </div>

          <!-- Error State -->
          @if(transactions.length === 0 && showReport && !isLoading) {
          <div class="row">
            <div class="col-12 text-center">
              <div class="alert alert-info">
                <h5>No Data Found</h5>
                <p>No transactions found for the selected criteria.</p>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- Loading State -->
    @if(isLoading) {
    <div class="row">
      <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading transaction report...</p>
      </div>
    </div>
    }
  </div>
</section>
