<section class="main-content">
  <div class="section-body">
    <div class="row">
      <form
        class="register-form"
        [formGroup]="register"
        (ngSubmit)="saleReturn(register)"
      >
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
          <div class="card mb-3">
            <div class="card-body-narrow">
              <div class="row">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="returnNumber" class="col-sm-4 col-form-label"
                      >Return Number:</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="returnNumber"
                        formControlName="returnNumber"
                        readonly
                      />
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="branch" class="col-sm-4 col-form-label"
                      >Return for:</label
                    >
                    <div class="col-sm-8">
                      <select
                        class="form-select form-control-sm"
                        formControlName="branchId"
                        required
                        [disabled]="true"
                      >
                        <option value="" selected disabled>
                          Please select
                        </option>
                        @for (option of branchs; track option) {
                        <option [value]="option.value">
                          {{ option.text }}
                        </option>
                        }
                      </select>
                      @if (!register.get('branchId')?.valid &&
                      register.get('branchId')?.touched) {
                      <small class="form-text text-danger">
                        Branch is required
                      </small>
                      }
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="returnDate" class="col-sm-4 col-form-label"
                      >Return Date:</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="date"
                        class="form-control form-control-sm"
                        id="returnDate"
                        formControlName="returnDate"
                        required
                      />
                      @if (!register.get('returnDate')?.valid &&
                      register.get('returnDate')?.touched) {
                      <small class="form-text text-danger">
                        Return Date is required
                      </small>
                      }
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="salesId" class="col-sm-4 col-form-label"
                      >Original Sales:</label
                    >
                    <div class="col-sm-8">
                      <select
                        class="form-select form-control-sm"
                        formControlName="salesId"
                        (change)="onSalesChange($any($event.target)?.value)"
                        required
                      >
                        <option value="" selected disabled>
                          Please select sales invoice
                        </option>
                        @for (sale of salesLookup; track sale) {
                        <option [value]="sale.id">
                          {{ sale.invoiceNumber }} -
                          {{ sale.customer.customerName }}
                        </option>
                        }
                      </select>
                      @if (!register.get('salesId')?.valid &&
                      register.get('salesId')?.touched) {
                      <small class="form-text text-danger">
                        Original Sales is required
                      </small>
                      }
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="customerId" class="col-sm-4 col-form-label"
                      >Customer:</label
                    >
                    <div class="col-sm-8">
                      <div class="input-group">
                        <select
                          class="form-select form-control-sm"
                          formControlName="customerId"
                          required
                          [disabled]="selectedSales"
                        >
                          <option value="" selected disabled>
                            Please select
                          </option>
                          @for (customer of customers; track customer) {
                          <option [value]="customer.value">
                            {{ customer.text }}
                          </option>
                          }
                        </select>
                        <button
                          type="button"
                          class="btn btn-outline-secondary btn-sm"
                          (click)="openCustomerModal()"
                        >
                          +
                        </button>
                      </div>
                      @if (!register.get('customerId')?.valid &&
                      register.get('customerId')?.touched) {
                      <small class="form-text text-danger">
                        Customer is required
                      </small>
                      }
                    </div>
                  </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  <div class="form-group row">
                    <label for="reason" class="col-sm-4 col-form-label"
                      >Return Reason:</label
                    >
                    <div class="col-sm-8">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        id="reason"
                        formControlName="reason"
                        placeholder="Enter return reason"
                        required
                      />
                      @if (!register.get('reason')?.valid &&
                      register.get('reason')?.touched) {
                      <small class="form-text text-danger">
                        Return reason is required
                      </small>
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Return Details Section -->
          <div class="card mb-3">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h5 class="card-title mb-0">Return Items</h5>
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="addReturnDetail()"
                [disabled]="!selectedSales"
              >
                Add Item
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Unit</th>
                      <th>Rate</th>
                      <th>Return Qty</th>
                      <th>Amount</th>
                      <th>Reason</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody formArrayName="saleReturnDetails">
                    @for (detail of saleReturnDetails.controls; track detail;
                    let i = $index) {
                    <tr [formGroupName]="i">
                      <td>
                        <select
                          class="form-select form-control-sm"
                          formControlName="productId"
                          required
                        >
                          <option value="" disabled>Select Product</option>
                          @for (product of products; track product) {
                          <option [value]="product.id">
                            {{ product.productName }}
                          </option>
                          }
                        </select>
                      </td>
                      <td>
                        <select
                          class="form-select form-control-sm"
                          formControlName="returnUnitId"
                          required
                        >
                          <option value="" disabled>Select Unit</option>
                          <!-- Unit options would be populated based on product -->
                        </select>
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control form-control-sm"
                          formControlName="rate"
                          readonly
                        />
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control form-control-sm"
                          formControlName="returnQuantity"
                          (input)="onQuantityChange(i)"
                          step="0.01"
                          min="0.01"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="number"
                          class="form-control form-control-sm"
                          formControlName="returnAmount"
                          readonly
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          class="form-control form-control-sm"
                          formControlName="reason"
                          placeholder="Item reason"
                          required
                        />
                      </td>
                      <td>
                        <button
                          type="button"
                          class="btn btn-danger btn-sm"
                          (click)="removeReturnDetail(i)"
                        >
                          Remove
                        </button>
                      </td>
                    </tr>
                    } @if (saleReturnDetails.length === 0) {
                    <tr>
                      <td colspan="7" class="text-center">
                        No return items added. Please add items to proceed.
                      </td>
                    </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Totals Section -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-8"></div>
                <div class="col-lg-4">
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label">Subtotal:</label>
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="subtotal"
                        readonly
                      />
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label">VAT (%):</label>
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="vatPercent"
                        (input)="calculateTotals()"
                        step="0.01"
                      />
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label">VAT Amount:</label>
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="vatAmount"
                        readonly
                      />
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label">Discount (%):</label>
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="discountPercent"
                        (input)="calculateTotals()"
                        step="0.01"
                      />
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label"
                      >Discount Amount:</label
                    >
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="discountAmount"
                        readonly
                      />
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label">Other Cost:</label>
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        formControlName="otherCost"
                        (input)="calculateTotals()"
                        step="0.01"
                      />
                    </div>
                  </div>
                  <div class="row mb-2">
                    <label class="col-sm-6 col-form-label"
                      ><strong>Total Return Amount:</strong></label
                    >
                    <div class="col-sm-6">
                      <input
                        type="number"
                        class="form-control form-control-sm fw-bold"
                        formControlName="returnAmount"
                        readonly
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-lg-12 text-end">
                  <button
                    type="button"
                    class="btn btn-secondary me-2"
                    (click)="resetForm()"
                  >
                    Reset
                  </button>
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="
                      !register.valid || saleReturnDetails.length === 0
                    "
                  >
                    {{ isEditing ? "Update" : "Create" }} Return
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>
