<section class="main-content">
  <div class="section-body">
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card mt-2">
          <span class="card-label">Purchase Invoices</span>
          <div class="p-10 mt-2">
            <form
              class="product-form"
              [formGroup]="criteriaForm"
              (ngSubmit)="getInvoiceData()"
            >
              <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                  <div class="form-group row">
                    <label for="product" class="col-sm-3 col-form-label"
                      >Find Invoice:</label
                    >
                    <div class="col-sm-9">
                      <div class="input-group input-group-select">
                        <ng-select
                          [items]="invoiceList"
                          bindLabel="text"
                          bindValue="value"
                          placeholder="Select Invoice"
                          formControlName="invoiceId"
                          [loading]="isInvoiceLoading"
                          (change)="getInvoiceData()"
                        >
                        </ng-select>
                        <div class="input-group-append">
                          <button
                            type="submit"
                            class="btn btn-primary px-2"
                            [disabled]="!criteriaForm.valid"
                          >
                            Show Invoice
                          </button>
                        </div>
                      </div>
                    </div>
                    @if (!criteriaForm.get('invoiceId')?.valid &&
                    criteriaForm.get('invoiceId')?.touched) {
                    <small class="form-text text-danger text-end">
                      Invoice is required
                    </small>
                    }
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="row clearfix">
      <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card" *ngIf="purchaseInvoice">
          <!-- Action Buttons (No Print) -->
          <div class="row no-print mb-3">
            <div class="col-12">
              <div class="d-flex gap-2 justify-content-end">
                <button type="button" class="btn" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back
                </button>
                <button type="button" class="btn" (click)="downloadPDF()">
                  <i class="fas fa-download me-1"></i>PDF Download
                </button>
                <button
                  type="button"
                  class="btn"
                  [openNewTab]="true"
                  [closeWindow]="false"
                  [previewOnly]="false"
                  [useExistingCss]="true"
                  printTitle="Purchase Invoice"
                  printSectionId="print-section-id"
                  ngxPrint
                >
                  <i class="fas fa-print me-1"></i>Print
                </button>
              </div>
            </div>
          </div>

          <div id="print-section-id" class="print-section-container">
            <div class="card invoice-card">
              <div class="card-body p-0">
                <!-- Invoice Print Area -->
                <div
                  #invoiceContent
                  id="invoice-content"
                  class="invoice-container"
                >
                  <!-- Report Header Component -->
                  <app-report-header></app-report-header>
                  <!-- Purchase Invoice Title -->
                  <div class="invoice-title-section">
                    <h4 class="text-center">Purchase Invoice</h4>
                  </div>

                  <!-- Invoice Details -->
                  <div class="invoice-details">
                    <div class="supplier-details">
                      <p>
                        <strong>Supplier Id:</strong>
                        {{ purchaseInvoice.supplier.supplierCode || "N/A" }}
                      </p>
                      <p>
                        <strong>Supplier Name:</strong>
                        {{ purchaseInvoice.supplier.supplierName || "N/A" }}
                      </p>

                      <p>
                        <strong>Supplier Mobile:</strong>
                        {{ purchaseInvoice.supplier.supplierMobile || "N/A" }}
                      </p>
                      <p>
                        <strong>Supplier Address:</strong>
                        {{ purchaseInvoice.supplier.address || "N/A" }}
                      </p>
                    </div>
                    <div class="purchase-details">
                      <p class="mb-1">
                        <strong>Date:</strong>
                        {{
                          purchaseInvoice?.invoiceDate
                            | date : "dd-MM-yyyy h:mm a"
                        }}
                      </p>
                      <p class="mb-1"><strong>Purchase by:</strong> Admin</p>
                      <p class="mb-1"><strong>Saved by:</strong> Admin</p>
                      <p class="mb-1">
                        <strong>Last edit:</strong>
                        {{
                          purchaseInvoice?.invoiceDate
                            | date : "dd-MM-yyyy h:mm a"
                        }}
                      </p>
                    </div>
                  </div>

                  <!-- Invoice Items Table -->
                  <div class="invoice-items">
                    <table>
                      <thead>
                        <tr>
                          <th class="text-center">Sl.</th>
                          <th class="text-center">Description</th>
                          <th class="text-center" style="width: 60px">
                            Warranty
                          </th>
                          <th class="text-center" style="width: 60px">Qnty</th>
                          <th class="text-center" style="width: 60px">
                            Unit Price
                          </th>
                          <th class="text-center" style="width: 60px">Dis.</th>
                          <th class="text-center" style="width: 80px">Total</th>
                        </tr>
                      </thead>
                      <tbody class="table-body">
                        <tr
                          *ngFor="
                            let item of purchaseInvoice?.purchaseDetails;
                            let i = index
                          "
                        >
                          <td class="text-center">{{ i + 1 }}</td>
                          <td>
                            <div>
                              <strong>{{
                                item.product.productName || "N/A"
                              }}</strong>
                            </div>
                            <div class="text-muted small">
                              S/N: {{ item.product.productCode || "N/A" }}
                            </div>
                            <div class="text-muted small">
                              Product Code:
                              {{ item.product.productCode || "N/A" }}
                            </div>
                            <div class="text-muted small">
                              Category: {{ item.product.categoryName || "N/A" }}
                            </div>
                          </td>
                          <td class="text-center">730 Days</td>
                          <td class="text-center">
                            {{ item.purchaseQuantity }}
                            {{ item.purchaseUnit?.unitName || "PCS" }}
                          </td>
                          <td class="text-center">
                            {{ item.purchaseRate | number : "1.2-2" }}
                          </td>
                          <td class="text-center">0.00</td>
                          <td class="text-end">
                            {{ item.purchaseAmount | number : "1.2-2" }}
                          </td>
                        </tr>

                        <!-- Total Row -->
                        <tr class="table-light">
                          <td colspan="3" class="text-end">
                            <strong>Total</strong>
                          </td>
                          <td class="text-center">
                            <strong>{{ getTotalQuantity() }}</strong>
                          </td>
                          <td colspan="2"></td>
                          <td class="text-end">
                            <strong>{{
                              purchaseInvoice?.subtotal | number : "1.2-2"
                            }}</strong>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Invoice Summary -->
                  <div class="invoice-summary">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="payment-info">
                          <table class="pull-left">
                            <tr>
                              <td><strong>Previous Due:</strong></td>
                              <td style="text-align: right">0</td>
                            </tr>
                            <tr>
                              <td><strong>Current Due:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                            <tr>
                              <td
                                colspan="2"
                                style="
                                  border-bottom: 1px solid rgb(204, 204, 204);
                                "
                              ></td>
                            </tr>
                            <tr>
                              <td><strong>Total Due:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                          </table>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="total-summary">
                          <table>
                            <tr>
                              <td><strong>Sub Total:</strong></td>
                              <td style="text-align: right">45000.00</td>
                            </tr>
                            <tr>
                              <td><strong>VAT:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                            <tr>
                              <td><strong>Discount:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                            <tr>
                              <td><strong>Transport Cost:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                            <tr>
                              <td
                                colspan="2"
                                style="
                                  border-bottom: 1px solid rgb(204, 204, 204);
                                "
                              ></td>
                            </tr>
                            <tr>
                              <td><strong>Total:</strong></td>
                              <td style="text-align: right">45000.00</td>
                            </tr>
                            <tr>
                              <td><strong>Cash Paid:</strong></td>
                              <td style="text-align: right">45000.00</td>
                            </tr>
                            <tr>
                              <td><strong>Bank Paid:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                            <tr>
                              <td
                                colspan="2"
                                style="
                                  border-bottom: 1px solid rgb(204, 204, 204);
                                "
                              ></td>
                            </tr>
                            <tr>
                              <td><strong>Due:</strong></td>
                              <td style="text-align: right">0.00</td>
                            </tr>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Amount in Words -->
                  <div class="amount-words">
                    <p class="mb-2">
                      <strong>In Word:</strong>
                      {{ convertToWords(purchaseInvoice?.invoiceAmount ?? 0) }}
                    </p>
                  </div>

                  <!-- Notes Section -->
                  <div class="notes-section">
                    <p class="mb-0"><strong>Note:</strong></p>
                  </div>

                  <!-- Report Footer Component -->
                  <app-report-footer></app-report-footer>
                </div>
                <!-- End Invoice Print Area -->
              </div>
            </div>
          </div>

          <!-- Error State -->
          <div class="row" *ngIf="!loadingIndicator && !purchaseInvoice">
            <div class="col-12 text-center">
              <div class="alert alert-warning">
                <h5>Invoice Not Found</h5>
                <p>The requested invoice could not be found.</p>
                <button class="btn btn-primary" (click)="goBack()">
                  <i class="fas fa-arrow-left me-1"></i>Go Back to Invoice List
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
